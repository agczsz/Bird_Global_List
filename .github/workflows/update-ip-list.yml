name: Update IP List

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas

    - name: Download and decompress IP list
      run: |
        curl -L "https://ipinfo.io/data/ipinfo_lite.csv.gz?token=${{ secrets.IPINFO_TOKEN }}" -o ipinfo_lite.csv.gz
        gzip -df ipinfo_lite.csv.gz

    - name: Run extraction script
      run: python extract.py

    - name: Generate RSC files
      run: python generate_rsc.py

    - name: Update README.md
      run: |
        UPDATE_TIME=$(date -u --iso-8601=seconds)
        > README.md
        echo "# Global IP Address Lists by Country" >> README.md
        echo "" >> README.md
        echo "**Note:** This data is automatically updated daily from [ipinfo.io](https://ipinfo.io/)." >> README.md
        echo "" >> README.md
        echo "---" >> README.md
        echo "" >> README.md
        echo "## ğŸ“Š Statistics" >> README.md
        echo "" >> README.md
        echo "**Last Updated:** ${UPDATE_TIME}" >> README.md
        echo "" >> README.md
        TOTAL_FILES=$(find Country_CIDR -type f -name "*.conf" | wc -l)
        TOTAL_CIDRS=$(grep -h "route" Country_CIDR/*.conf | wc -l)
        echo "### ğŸ“ˆ Overall" >> README.md
        echo "- **Total Countries/Regions with data:** ${TOTAL_FILES}" >> README.md
        echo "- **Total IP CIDR blocks:** ${TOTAL_CIDRS}" >> README.md
        echo "" >> README.md
        echo "### ğŸŒ Top 20 Countries by CIDR Count" >> README.md
        echo "" >> README.md
        echo "| Country Code | CIDR Count |" >> README.md
        echo "|--------------|------------|" >> README.md
        grep -c "route" Country_CIDR/*.conf | sed -e 's/Country_CIDR\///' -e 's/.conf:/ /' | sort -k2 -nr | head -n 20 | awk '{printf "| %-12s | %-10s |\n", $1, $2}' >> README.md
        echo "" >> README.md
        echo "---" >> README.md
        echo "" >> README.md
        echo "*This information was automatically updated by GitHub Actions on ${UPDATE_TIME}*" >> README.md
    - name: Remove large files
      run: |
        find Country_CIDR/ -type f -size +98M -delete
        find Country_CIDR_RSC/ -type f -size +98M -delete
        echo "å·²æ¸…ç†è¶…å¤§æ–‡ä»¶ï¼Œé˜²æ­¢ Push å¤±è´¥ã€‚"
        
    - name: Commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Automated IP list update"
        file_pattern: "Country_CIDR/*.conf Country_CIDR_RSC/*.rsc README.md"
        commit_user_name: "GitHub Actions"
        commit_user_email: "actions@github.com"
        commit_author: "GitHub Actions <actions@github.com>"
